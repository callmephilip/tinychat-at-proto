import { Database } from '@db/sqlite';
import { TID } from '@atproto/common';
import { ValidationResult } from '@atproto/lexicon';
import { getProjectRoot, getTimeus, removeNulls, sleep } from 'tinychat/utils.ts';
import path  from 'node:path';
// ðŸ¦• AUTOGENERATED! DO NOT EDIT! File to edit: db.ipynb




export type { Database } from "@db/sqlite";





export function fetchView<T>(
  { db, sql, validate }: {
    db: Database;
    sql: string;
    validate: (v: unknown) => ValidationResult;
  },
): T[] {
  console.log("Fetching view using sql:", sql);
  return db.prepare(sql).all().map((r) => {
    return Object.keys(r).reduce((acc, k) => {
      if (!k.includes("__")) {
        return Object.assign(acc, { [k]: r[k] });
      }

      const [parent, attr] = k.split("__");

      if (parent === attr) {
        return Object.assign(acc, {
          [parent]: JSON.parse(r[k]),
        });
      }

      return Object.assign(acc, {
        // @ts-ignore yolo
        [parent]: Object.assign(acc[parent] || {}, { [attr]: r[k] }),
      });
    }, {});
  }).map(removeNulls).map((r) => {
    const v = validate(r);
    if (!v.success) {
      console.error("Failed to validate view", v);
    }
    // @ts-ignore yolo
    return v.value;
  }).filter((v) => v);
}



const tables: Record<string, string> = {
  users: `
    CREATE TABLE users (
      did TEXT PRIMARY KEY,
      handle TEXT NOT NULL,
      display_name TEXT,
      avatar TEXT,
      description TEXT
    )`,
  servers: `
    CREATE TABLE servers (
      uri TEXT PRIMARY KEY,
      name TEXT NOT NULL,
      creator TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (creator) REFERENCES users(did)
    );`,
  channels: `CREATE TABLE channels (
  id TEXT,
  name TEXT NOT NULL,
  server TEXT NOT NULL,
  latest_message_received_time_us TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id, server),
  FOREIGN KEY (server) REFERENCES servers(uri) ON DELETE CASCADE
);`,
  server_memberships: `CREATE TABLE server_memberships (
  uri TEXT PRIMARY KEY NOT NULL,
  user TEXT NOT NULL,
  server TEXT NOT NULL,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (server) REFERENCES servers(uri) ON DELETE CASCADE
  FOREIGN KEY (user) REFERENCES users(did) ON DELETE CASCADE
);`,
  messages: `CREATE TABLE messages (
  uri TEXT PRIMARY KEY,
  channel TEXT NOT NULL,
  server TEXT NOT NULL,
  text TEXT NOT NULL,
  sender TEXT NOT NULL,
  created_at DATETIME NOT NULL,
  deleted_at DATETIME,
  time_us TEXT NOT NULL,
  FOREIGN KEY (channel, server) REFERENCES channels(id, server),
  FOREIGN KEY (server) REFERENCES servers(uri) ON DELETE CASCADE
  FOREIGN KEY (sender) REFERENCES users(did) ON DELETE CASCADE
);
`,
  read_receipts: `CREATE TABLE read_receipts (
  channel TEXT NOT NULL,
  server TEXT NOT NULL,
  user TEXT NOT NULL,
  time_us TEXT NOT NULL,
  PRIMARY KEY (user, channel, server),
  FOREIGN KEY (channel, server) REFERENCES channels(id, server) ON DELETE CASCADE,
  FOREIGN KEY (user) REFERENCES users(did)
);`,
};

let __db: Database | null = null;

export const getDatabase = (
  { reset }: { reset: boolean } = { reset: false },
): Database => {
  if (__db && !reset) {
    return __db;
  }

  const dbPath = Deno.env.get("DB_URL") &&
    path.join(getProjectRoot(), Deno.env.get("DB_URL")!);

  console.log("DB_PATH is", dbPath);

  try {
    __db = new Database(dbPath || ":memory:");
  } catch {
    console.error("Failed to open database at", dbPath);
    console.log("Trying with", Deno.env.get("DB_URL"));
    __db = new Database(Deno.env.get("DB_URL") || ":memory:");
  }

  // WAL please
  __db.exec("pragma journal_mode = WAL");

  // foreing keys on
  __db.exec("pragma foreign_keys = ON");

  const existingTables = __db
    .prepare("SELECT name FROM sqlite_master WHERE type='table'")
    .all<{ name: string }>();

  Object.keys(tables).forEach((table) => {
    if (!existingTables.some((t) => t.name === table)) {
      __db && __db.prepare(tables[table]).run();
    }
  });

  // create triggers and etc
  __db.prepare(`DROP TRIGGER IF EXISTS update_channel_latest_message;`).run();
  __db.prepare(`DROP VIEW IF EXISTS channel_view;`).run();
  __db.prepare(`DROP VIEW IF EXISTS message_view;`).run();
  __db.prepare(`DROP VIEW IF EXISTS server_view;`).run();
  __db.prepare(`DROP VIEW IF EXISTS server_view_with_viewer;`).run();
  __db.prepare(`DROP VIEW IF EXISTS server_with_members_view;`).run();

  __db
    .prepare(
      `CREATE TRIGGER update_channel_latest_message
    AFTER INSERT ON messages
    BEGIN
      UPDATE channels
      SET latest_message_received_time_us = NEW.time_us
      WHERE id = NEW.channel AND (latest_message_received_time_us IS NULL OR NEW.time_us > latest_message_received_time_us);
    END;`,
    )
    .run();

  // simple server view when viewer is not present
  __db
    .prepare(
      `CREATE VIEW server_view AS
       SELECT s.uri, s.name,
        u.did as creator__did,
        u.handle as creator__handle,
        u.display_name as creator__display_name,
        u.avatar as creator__avatar,
        u.description as creator__description,
        json_group_array(
          json_object(
            'id', c.id,
            'name', c.name,
            'server', c.server,
            'latestMessageReceivedTime', c.latest_message_received_time_us
          )
        ) as channels__channels 
      FROM servers s
      INNER JOIN channels c ON c.server = s.uri
      INNER JOIN users u ON u.did = s.creator
      GROUP BY s.uri;
    `,
    )
    .run();

  // server view with members
  __db
    .prepare(
      `CREATE VIEW server_with_members_view AS
       SELECT s.uri, s.name,
        u.did as creator__did,
        u.handle as creator__handle,
        u.display_name as creator__display_name,
        u.avatar as creator__avatar,
        u.description as creator__description,
        json_group_array(
          json_object(
            'id', c.id,
            'name', c.name,
            'server', c.server,
            'latestMessageReceivedTime', c.latest_message_received_time_us
          )
        ) as channels__channels,
        sm.user as member  
      FROM servers s
      INNER JOIN channels c ON c.server = s.uri
      INNER JOIN users u ON u.did = s.creator
      INNER JOIN server_memberships sm ON sm.server = s.uri
      GROUP BY sm.user, s.uri;
    `,
    )
    .run();

  // server view with viewer
  __db
    .prepare(
      `CREATE VIEW server_view_with_viewer AS
        SELECT 
          s.uri,
          s.name,
          u.did as creator__did,
          u.handle as creator__handle,
          u.display_name as creator__display_name,
          u.avatar as creator__avatar,
          u.description as creator__description,
          c.user as viewer,
          json_group_array(
            json_object(
              'id', c.id,
              'name', c.name,
              'server', c.server,
              'lastMessageReadTime', c.last_message_read_time_us,
              'latestMessageReceivedTime', c.latest_message_received_time_us
            )
          ) as channels__channels
          FROM servers s
          LEFT OUTER JOIN channel_view c ON c.server = s.uri
          INNER JOIN users u ON u.did = s.creator
          GROUP BY s.uri;
      `,
    )
    .run();

  __db
    .prepare(
      `CREATE VIEW channel_view AS
       SELECT c.*, sm.user, COALESCE(rr.time_us, NULL) as last_message_read_time_us
       FROM channels c
       JOIN server_memberships sm ON sm.server = c.server
       LEFT JOIN read_receipts rr ON rr.channel = c.id AND rr.user = sm.user AND rr.server = sm.server;`,
    )
    .run();

  __db
    .prepare(
      `CREATE VIEW message_view AS
       SELECT uri, channel, server, text, sender, created_at as createdAt, time_us, users.did, users.handle, users.display_name as displayName,
              users.avatar, users.description
       FROM messages
       INNER JOIN users ON messages.sender = users.did`,
    )
    .run();

  return __db;
};
const messagingSeed =
  `**Bom dia!** Fancy a bite of *Bacalhau Ã  BrÃ¡s* today? ðŸ‡µðŸ‡¹ A classic Portuguese dish of shredded cod, onions, and fried potatoesâ€”comfort food at its finest!
Want to explore **Portuguese pastries**? ðŸ¥ Try the iconic *PastÃ©is de Nata*! Crispy, creamy, and best with a sprinkle of cinnamon.
**Curious about Portuguese wine?** ðŸ· Check out the [Vinho Verde](https://en.wikipedia.org/wiki/Vinho_Verde)â€”a fresh, slightly effervescent wine perfect with seafood! ðŸŸ
*Fun fact*: There are **365 ways** to prepare Bacalhau (salted cod) in Portugalâ€”one for each day of the year! ðŸ¤©
Canâ€™t visit Lisbon? Bring it home! Try making a **Piri-Piri Chicken** recipe tonight. Spicy and flavorful. ðŸŒ¶ï¸ ðŸ—
**Question of the day**: Do you prefer your *Bolinhos de Bacalhau* crispy or fluffy? ðŸ˜‹
If you love *sardines*, donâ€™t miss the annual **Lisbon Sardine Festival** in June! ðŸŸðŸŽ‰
*Feeling thirsty?* Why not make a refreshing **Sangria** with a Portuguese twist? Add Vinho Verde and citrus fruits! ðŸŠ
**Quick tip:** Always pair your *PastÃ©is de Nata* with a shot of **Portuguese espresso**â€”small but mighty! â˜•
**Resource spotlight:** Learn more about Portuguese cuisine with this guide: [Portuguese Food 101](https://www.theguardian.com/portuguese-cuisine-guide).
*Legend has it* that Portuguese sailors brought chili peppers to Europeâ€”ever heard of their **Piri-Piri Sauce**? ðŸŒ¶ï¸ðŸ”¥
Craving *comfort food*? Nothing beats a warm bowl of **Caldo Verde** with chorizo and cornbread! ðŸ¥–ðŸ²
Did you know? *Portuguese olive oil* is some of the best in the worldâ€”perfect for dipping bread or drizzling over salads! ðŸ«’
Why is *Bacalhau* salted? **Answer**: Itâ€™s a preservation method used by Portuguese fishermen centuries ago! ðŸŸâš“
**Need ideas for seafood?** Try making *AmÃªijoas Ã  BulhÃ£o Pato* (clams in garlic and wine sauce). Simple yet delicious! ðŸ‹
Ever tried **Francesinha**? ðŸ‡µðŸ‡¹ Think of it as a Portuguese sandwich stacked with meats, cheese, and a rich beer sauce. ðŸº ðŸ¥ª
*Portuguese food on a budget*: Pick up some **canned sardines**â€”a national treasureâ€”and serve them with crusty bread. ðŸŸðŸž
Did you know **Peri-Peri Chicken** is a blend of Portuguese and African flavors? A spicy global favorite! ðŸŒðŸ”¥
**Spotlight dish:** Polvo Ã  Lagareiro (octopus with olive oil and garlic)â€”a favorite on Portugalâ€™s coast! ðŸ™
Feeling bold? Try the traditional *Tripas Ã  Moda do Porto*â€”a tripe stew from northern Portugal. Not for the faint-hearted! ðŸ²
If you could eat *only one Portuguese dish for life,* what would it be? ðŸ¤” *My pick: Bacalhau Ã  BrÃ¡s!*
Want to bake something new? **PÃ£o de Deus** ("Bread of God") is a sweet coconut-topped bread perfect for breakfast. ðŸ¥¥ðŸž
**Pro tip:** Pair a glass of **Port wine** with a slice of dark chocolateâ€”itâ€™s divine! ðŸ·ðŸ«
Love rice? Try *Arroz de Marisco* (Portuguese seafood rice)â€”rich, creamy, and packed with flavor. ðŸ¤ðŸš
Whatâ€™s your favorite **Portuguese spice**? Mineâ€™s *piri-piri*â€”a little goes a long way! ðŸŒ¶ï¸
Discover the **Azorean specialty**: *Alcatra*â€”a slow-cooked beef stew served with fresh bread. ðŸ–
Bring Portugal home! Learn to make *PÃ£o Alentejano*, the rustic bread from the Alentejo region. ðŸ¥–
**Snack spotlight**: RissÃ³isâ€”crispy Portuguese empanadas filled with shrimp or beef. A must-try! ðŸ¦ðŸ¥Ÿ
Raise your hand ðŸ™‹ if youâ€™re a fan of **Portuguese charcuterie**: chouriÃ§o, presunto, and more. ðŸ–ðŸ§€
*Did you know?* The Portuguese introduced tea culture to Britain! Sip some **Gorreana tea** from the Azores. ðŸµ
Ever heard of *Choco Frito*? Itâ€™s **fried cuttlefish**, a beloved dish in SetÃºbal. Think calamari but better! ðŸ¦‘
Treat yourself to **Bolo de Arroz**â€”Portuguese rice flour muffins with a hint of lemon. ðŸ‹
Time to bake? Try making a **Bola de Berlim**, Portugalâ€™s version of a donut with custard filling! ðŸ©
Check out this Portuguese cookbook for ideas: [Lisbon to the Table](https://example.com)! ðŸ“š
*Dreaming of summer?* Nothing screams Portuguese summer like grilled **sardines** by the seaside! ðŸŸðŸŒŠ
**Challenge**: Make an authentic *Feijoada* (bean stew) this weekend. Bonus points for pairing it with rice! ðŸ›
Feeling adventurous? *Caracois*â€”Portuguese-style snailsâ€”are a must-try for the curious foodie! ðŸŒ
Toast to Portugal with a glass of **Porto Tonic**â€”white port, tonic water, and lime. Refreshing! ðŸ¹
Whatâ€™s your take on Portuguese desserts? *Arroz Doce* (sweet rice pudding) or *Toucinho do CÃ©u* (almond cake)? ðŸ°
Want to impress? Serve **Lapas Grelhadas**â€”grilled limpets with garlic butter. Coastal Portugal in a bite! ðŸš
ðŸ‡µðŸ‡¹ Explore the flavors of **Alentejo cuisine**: hearty pork dishes, stews, and bread-based recipes. ðŸ–ðŸ¥–
Curious about *Azorean cuisine*? Try **Cozido das Furnas**, a geothermal-cooked stew unique to the islands. ðŸŒ‹
Did you know? Portuguese *Espetada* (meat skewers) originated in Madeira. Perfect for grilling! ðŸ¢
**Cheese lovers unite!** ðŸ§€ Taste *Queijo da Ilha*, an Azorean cheese with bold flavor.
Discover **Portugalâ€™s National Soup**: *Caldo Verde*â€”kale, potatoes, and chouriÃ§o. Healthy and heartwarming. ðŸ¥£
Want to level up? Pair grilled fish with *salada de pimentos assados* (roasted pepper salad). ðŸŒ¶ï¸
Learn the art of making *Ginjinha*! ðŸ’ A cherry liqueur that Lisbon locals love to sip.
Did someone say *desserts?* **PÃ£o de LÃ³** is a fluffy Portuguese sponge cakeâ€”irresistible! ðŸ°
**Bom dia, food lovers!** ðŸŒ… Start your day the Portuguese way with a bite of *PastÃ©is de Nata*â€”crispy puff pastry filled with creamy custard, topped with a dash of cinnamon or powdered sugar. Pair it with a bold Portuguese espresso for the ultimate breakfast experience! â˜• ðŸ‡µðŸ‡¹
*Ever wondered what to do with salted cod?* ðŸŸ Try **Bacalhau Ã  BrÃ¡s**, a beloved dish made with shredded codfish, sautÃ©ed onions, crispy fried potatoes, and scrambled eggs. Itâ€™s comfort food with a touch of sophistication!
**Did you know?** The Portuguese brought spices like cinnamon, nutmeg, and chili to Europe during the Age of Exploration. These spices are now an integral part of Portuguese cuisine, elevating dishes like *Arroz Doce* (sweet rice pudding) to aromatic perfection. ðŸŒâœ¨
Letâ€™s talk about **Caldo Verde**, a simple yet soul-warming kale and potato soup. ðŸ¥¬ Traditionally served with slices of chouriÃ§o (Portuguese sausage) and rustic cornbread, this dish is a staple at Portuguese family dinners and festas.
Craving seafood? ðŸ¦‘ Dive into the flavors of *Polvo Ã  Lagareiro*! This dish features roasted octopus drenched in olive oil and garlic, served with crispy potatoes. A coastal classic, it captures the essence of Portugalâ€™s maritime heritage. ðŸŒŠ
**Wine lovers, rejoice!** ðŸ· Portugalâ€™s **Vinho Verde** isnâ€™t just a wineâ€”itâ€™s a celebration of freshness. Slightly sparkling, light, and citrusy, it pairs beautifully with grilled sardines, seafood, or even a sunny afternoon.
Feeling adventurous? ðŸŒ Try *CaracÃ³is*! These tiny Portuguese-style snails are simmered in a flavorful broth of garlic, oregano, and white wine. Theyâ€™re a summertime favorite served with crusty bread and cold beer.
Letâ€™s celebrate *Lisbonâ€™s culinary gem*, the **Francesinha**! ðŸ¥ª This hearty sandwich from Porto layers meats, cheese, and a fried egg, then smothers it all in a rich beer-based sauce. Pair with crispy fries for a true Portuguese indulgence!
*Did you know?* Portugal is home to **Port wine**, one of the worldâ€™s finest fortified wines. From ruby to tawny, each sip tells a story of the Douro Valleyâ€™s sun-kissed vineyards. Pair it with blue cheese or chocolate for an unforgettable tasting. ðŸžï¸
Have you ever tried *Bola de Berlim*? ðŸ© This Portuguese take on the donut is filled with rich custard cream instead of jam, making it the perfect snack for coffee breaks or lazy afternoons. *Pro tip*: Best enjoyed fresh from a pastelaria!
**Sweet or savory?** ðŸ‡µðŸ‡¹ Portuguese food is all about balance. Enjoy a slice of *Bolo de Arroz* (rice cake) for breakfast, then savor *Arroz de Pato* (duck rice) for dinnerâ€”a baked rice dish bursting with the flavors of duck, chouriÃ§o, and citrus zest.
Want to spice up your cooking? ðŸŒ¶ï¸ Make your own *Piri-Piri Sauce*! Blend birdâ€™s eye chilies, garlic, olive oil, and vinegar. Use it as a marinade for chicken, a condiment for seafood, or a dip for crusty bread. Your taste buds will thank you!
*Transport yourself to the Azores* with **Cozido das Furnas**! ðŸŒ‹ This unique stew is slow-cooked underground using volcanic steam. Packed with meats, vegetables, and sausages, itâ€™s a true taste of Portugalâ€™s geothermal wonders.
Feeling festive? ðŸŽ‰ Nothing beats the **Lisbon Sardine Festival**! Celebrate with grilled sardines, smoky *Salada de Pimentos Assados* (roasted peppers), and traditional music. *Canâ€™t make it?* Host your own version at home with friends and family. ðŸŸ
**Cheese lovers, take note!** ðŸ§€ Portugal boasts some of the worldâ€™s finest artisanal cheeses. Try *Queijo da Serra da Estrela*, a creamy sheepâ€™s cheese from the mountains, served with crusty bread and a drizzle of honey. ðŸ‘ðŸ¯
Have you heard of *Tripas Ã  Moda do Porto*? ðŸ² This hearty tripe stew is a symbol of Portoâ€™s resilience and culinary tradition. Made with beans, sausage, and slow-cooked meats, itâ€™s a flavorful dish that warms the soul.
Feeling creative in the kitchen? ðŸ¥– Bake *PÃ£o Alentejano*, a traditional bread from the Alentejo region. Its rustic crust and soft interior make it perfect for dipping into olive oil or pairing with hearty soups. ðŸ²
**Did you know?** Portuguese egg-based desserts like *Toucinho do CÃ©u* (Heavenâ€™s Lard) were invented by nuns in monasteries. These sweet treats are rich with egg yolks, sugar, and almondsâ€”a legacy of centuries-old culinary artistry. ðŸ®
*Grilled sardines are more than foodâ€”theyâ€™re culture!* ðŸŸ Seasoned simply with salt and grilled to perfection, theyâ€™re served with potatoes and roasted peppers. Pair with a glass of *Vinho Verde* for an authentic Portuguese experience.
Letâ€™s talk about *Alheira*, Portugalâ€™s **smoky garlic sausage**. Originally created by Jewish communities, itâ€™s now a beloved dish enjoyed fried, grilled, or baked, often served with fried eggs and potatoes. ðŸ³
**Hosting a dinner?** Impress your guests with *Arroz de Tamboril*â€”a monkfish rice dish with tomatoes, garlic, and herbs. Itâ€™s like a Portuguese risotto, but with a seafood twist! ðŸ¤
In the mood for something sweet? ðŸ« Try *Salame de Chocolate*â€”a no-bake chocolate â€œsalamiâ€ made with crushed biscuits, cocoa, and condensed milk. Slice it thin and serve with coffee for a decadent treat.
*Looking for street food?* ðŸŒ­ Grab a **Bifana**, Portugalâ€™s iconic pork sandwich. Thinly sliced marinated pork is stuffed into a fresh roll and doused with mustard or hot sauce. Simple, satisfying, and so delicious!
**Discover Madeira!** ðŸï¸ This Portuguese island is famous for its unique cuisine. Try *Espetada Madeirense*, beef skewers marinated in garlic and bay leaf, cooked over an open flame. Pair with the islandâ€™s famous Madeira wine! ðŸ–
**Bom dia, foodies!** ðŸ‡µðŸ‡¹ Todayâ€™s spotlight is on *Bacalhau Ã  BrÃ¡s*, one of Portugalâ€™s most beloved dishes. Itâ€™s made with shredded salted cod, finely chopped onions, crispy matchstick potatoes, and eggs all mixed into a creamy, flavorful delight. Garnish with parsley and olives for that extra touch. Perfect for lunch or dinner! ðŸŸ
**Sweet tooth alert!** ðŸ¬ If you havenâ€™t tried *PastÃ©is de Nata*, youâ€™re missing out on a piece of heaven. These iconic custard tarts, with their flaky, buttery crust and creamy custard filling, are a must-try. Best served slightly warm with a dusting of cinnamon and powdered sugar. *Pro tip*: Pair with a strong shot of Portuguese espresso. â˜•
**Portuguese wine education:** ðŸ· Have you heard of *Vinho Verde*? This "green wine" isn't literally green but refers to its youthful freshness. Itâ€™s slightly fizzy, delightfully crisp, and pairs beautifully with seafood like grilled sardines or a platter of *AmÃªijoas Ã  BulhÃ£o Pato* (clams in garlic and white wine sauce). Cheers! ðŸ¥‚
*Did you know?* Portugal consumes more codfish (or *bacalhau*) than any other country in the world, even though it doesnâ€™t naturally occur in Portuguese waters. There are said to be **365 recipes** for cooking bacalhau, one for each day of the year. Whatâ€™s your favorite cod dish? ðŸŸ
**Feeling adventurous in the kitchen?** Try making *Francesinha* tonight! ðŸ” This legendary sandwich from Porto is layered with cured meats, steak, and sausage, topped with melted cheese, and drenched in a spicy beer-based sauce. Donâ€™t forget to serve it with fries for dipping. *Warning: Itâ€™s messy but oh-so-worth it!* ðŸŸ
**Spotlight on Caldo Verde**: This simple yet heartwarming soup is a staple in Portuguese homes. It combines potatoes, onions, and garlic, blended into a creamy base, with ribbons of tender kale and slices of smoky chouriÃ§o sausage. Serve with cornbread (*broa*) for the ultimate comfort meal. Perfect for cold evenings! ðŸ¥–ðŸ¥£
Thinking about desserts? ðŸ° Donâ€™t sleep on *Arroz Doce*! This creamy Portuguese rice pudding is made with Arborio rice, milk, sugar, and a touch of lemon zest, then finished with a sprinkle of cinnamon. Itâ€™s simple, comforting, and nostalgic. A perfect way to end any meal! ðŸŒŸ
*Fun fact:* Portugal is one of the worldâ€™s top producers of **cork**â€”yes, as in wine bottle stoppers! ðŸ¾ But did you know the cork oak forests (known as *montado*) also provide a habitat for wild boar and support local cuisines with dishes like *Porco Preto* (black pork)? ðŸ–
Have you ever tried **Portuguese-style BBQ**? ðŸ– *Espetadas*, or skewered meats, are a Madeira Island specialty. Traditionally grilled over an open flame and seasoned simply with garlic, bay leaves, and salt, theyâ€™re served with crispy potatoes and a drizzle of olive oil. Perfect for outdoor gatherings!
**Craving fried goodness?** *RissÃ³is de CamarÃ£o* are golden, crescent-shaped empanadas filled with a creamy shrimp filling. These savory snacks are found in bakeries across Portugal and are perfect for parties or casual snacking. Pair with a cold beer for the ultimate combo! ðŸ¤ðŸº
Want to sip like a local? ðŸ¸ Try *Ginjinha*, a sweet cherry liqueur thatâ€™s often served in a tiny chocolate cup. Itâ€™s a Lisbon favorite, especially in the Bairro Alto district. Visit one of the iconic ginjinha bars next time youâ€™re in Portugalâ€”or try making your own at home!
**Dessert spotlight:** *Toucinho do CÃ©u* (literally â€œBacon from Heavenâ€) isnâ€™t made with bacon but gets its name from its heavenly flavor. This rich almond cake is infused with egg yolks and sugarâ€”a legacy of Portuguese convent recipes. Perfect with tea or coffee. ðŸ®
ðŸŒŠ Dreaming of coastal Portugal? Try cooking *AmÃªijoas Ã  BulhÃ£o Pato* at home: fresh clams sautÃ©ed with garlic, olive oil, lemon, and cilantro. Serve with crusty bread to soak up the flavorful brothâ€”itâ€™s like bringing the seaside to your kitchen! ðŸš
Looking for a *quick snack*? Portugalâ€™s *Bifanas* are mouthwatering pork sandwiches seasoned with garlic and white wine. Usually served in a soft roll, theyâ€™re simple yet packed with flavor. Pair with mustard or hot sauce for a spicy kick! ðŸ¥ª
Are you a fan of **regional specialties**? Donâ€™t miss the Alentejo regionâ€™s *AÃ§orda Alentejana*, a comforting garlic and cilantro bread soup topped with a poached egg. Rustic, humble, and unforgettable. ðŸ³
*Thinking of a drink?* Portugal is famous for its **Port wine**, but donâ€™t overlook *Moscatel de SetÃºbal*. This sweet dessert wine boasts flavors of honey, orange blossom, and dried fruits. Pair it with cheese or pastries for a true indulgence. ðŸ·
ðŸ‡µðŸ‡¹ *Did you know?* Lisbon is famous for its **rooftop bars**, where you can enjoy drinks like *Porto Tonic* (white port and tonic water) while overlooking iconic landmarks like the Tagus River or SÃ£o Jorge Castle. A truly unforgettable experience!`;

export const seedMessages = ({
  db,
  server,
}: {
  db: Database;
  server: string;
}) => {
  const user = db
    .prepare("SELECT user FROM server_memberships WHERE server = :server")
    .all<{ user: string }>({ server })
    .map((u) => u.user)[0];
  const channel = db
    .prepare("SELECT id FROM channels WHERE server = :server")
    .get<{ id: string }>({ server })!.id;

  messagingSeed.split("\n").forEach((text, i) => {
    db.prepare(
      `INSERT INTO messages (uri, channel, server, text, sender, created_at, time_us) VALUES (
      :uri, :channel, :server, :text, :sender, :created_at, :time_us
    )`,
    ).run({
      uri:
        `at://did:plc:ubdeopbbkbgedccgbum7dhsh/chat.tinychat.core.message/${TID.nextStr()}`,
      channel,
      server,
      text: `[${i + 1}] ${text}`,
      sender: user,
      created_at: new Date().toISOString(),
      time_us: `${new Date().getTime() * 1000 + 60 * (i * 1000)}`, // add offset that is based on minute * i
    });
  });
};


export class TestDatabase {
  constructor(public db: Database = getDatabase({ reset: true })) {}

  public static server: string =
    "at://did:plc:ubdeopbbkbgedccgbum7dhsh/chat.tinychat.core.server/3lgfm4edsy72b";
  public static server2: string =
    "at://did:plc:ubdeopbbkbgedccgbum7dhsh/chat.tinychat.core.server/3lgfm4edsy767";
  public static user1: string = "did:plc:ubdeopbbkbgedccgbum7dhsh";
  public static user2: string = "did:plc:ubdeopbbkbgedccgbum7dhop";
  public static channel1: string = TID.nextStr();
  public static channel2: string = TID.nextStr();

  public static setup(
    { messages }: { messages: boolean } = { messages: true },
  ): TestDatabase {
    const service = new TestDatabase();
    // insert 2 test users
    [0, 1].forEach((i) => {
      service.db
        .prepare(
          `
        INSERT INTO users (did, handle, display_name, avatar, description) VALUES (
          :did, :handle, :display_name, :avatar, :description
        )
      `,
        )
        .run({
          did: [TestDatabase.user1, TestDatabase.user2][i],
          handle: "callmephilip.com",
          display_name: null,
          avatar: null,
          description: null,
        });
    });
    // create test server
    service.db
      .prepare(
        `
      INSERT INTO servers (uri, name, creator) VALUES (
        :uri, :name, :creator
      )
    `,
      )
      .run({
        uri: TestDatabase.server,
        name: "Test Server",
        creator: TestDatabase.user1,
      });

    // create memberships for both users
    [0, 1].forEach((i) => {
      service.db
        .prepare(
          `
        INSERT INTO server_memberships (uri, user, server) VALUES (
          :uri, :user, :server
        )
      `,
        )
        .run({
          uri:
            `at://did:plc:ubdeopbbkbgedccgbum7dhsh/chat.tinychat.core.membership/${TID.nextStr()}`,
          user: [TestDatabase.user1, TestDatabase.user2][i],
          server: TestDatabase.server,
        });
    });

    // setup channels
    [TestDatabase.channel1, TestDatabase.channel2].forEach((c) => {
      service.db
        .prepare(
          `
        INSERT INTO channels (id, name, server) VALUES (
          :id, :name, :server
        )
      `,
        )
        .run({
          id: c,
          name: `channel ${c}`,
          server: TestDatabase.server,
        });
    });

    // set up another chat server
    service.db
      .prepare(
        `
      INSERT INTO servers (uri, name, creator) VALUES (
        :uri, :name, :creator
      )
    `,
      )
      .run({
        uri: TestDatabase.server2,
        name: "Test Server 2",
        creator: TestDatabase.user1,
      });

    // create memberships for both users
    [TestDatabase.user1, TestDatabase.user2].forEach((user) => {
      service.db
        .prepare(
          `
        INSERT INTO server_memberships (uri, user, server) VALUES (
          :uri, :user, :server
        )
      `,
        )
        .run({
          uri:
            `at://did:plc:ubdeopbbkbgedccgbum7dhsh/chat.tinychat.core.membership/${TID.nextStr()}`,
          user,
          server: TestDatabase.server2,
        });
    });

    // setup channels
    [1, 2].forEach((i) => {
      service.db
        .prepare(
          `
        INSERT INTO channels (id, name, server) VALUES (
          :id, :name, :server
        )
      `,
        )
        .run({
          id: TID.nextStr(),
          name: `channel server 2 ${i}`,
          server: TestDatabase.server2,
        });
    });

    if (messages) {
      seedMessages({ db: service.db, server: TestDatabase.server });
    }

    return service;
  }

  public user1MessagesChannel1(text: string, timestamp: string = getTimeus()) {
    this.receiveMessage({
      channel: TestDatabase.channel1,
      server: TestDatabase.server,
      text,
      createdAt: new Date().toISOString(),
      uri:
        `at://did:plc:ubdeopbbkbgedccgbum7dhsh/chat.tinychat.core.message/${TID.nextStr()}`,
      sender: TestDatabase.user1,
      time_us: timestamp,
    });
  }

  public receiveMessage({
    channel,
    server,
    text,
    createdAt,
    uri,
    sender,
    time_us,
  }: {
    channel: string;
    server: string;
    text: string;
    createdAt: string;
    uri: string;
    sender: string;
    time_us: string;
  }) {
    this.db
      .prepare(
        `
      INSERT INTO messages (uri, channel, server, text, sender, created_at, time_us) VALUES (
        :uri, :channel, :server, :text, :sender, :created_at, :time_us
      )`,
      )
      .run({
        uri,
        channel,
        server,
        text,
        sender,
        created_at: createdAt,
        time_us: time_us,
      });
  }

  public addUser() {
    const did = `did:plc:${TID.nextStr()}`;
    const handle = `${TID.nextStr()}.bsky.social`;
    this.db
      .prepare(
        `
      INSERT INTO users (did, handle, display_name, avatar, description) VALUES (
        :did, :handle, :display_name, :avatar, :description
      )`,
      )
      .run({ did, handle, display_name: handle });
    return this.db.prepare(`SELECT * FROM users WHERE did = :did`).get({ did });
  }
}


export async function waitForSync<T>(
  { db, op, sql }: {
    db: Database;
    op: () => Promise<T>;
    sql: string | ((input: T) => string);
  },
) {
  const maxTries = 10;
  const pauseMs = 500;
  const r = await op();
  const s = typeof sql === "string" ? sql : sql(r);
  let tries = 0;

  while (true) {
    tries++;
    const res = db.prepare(s).all();
    if (res.length > 0) {
      break;
    }
    await sleep(pauseMs);

    if (tries >= maxTries) {
      throw new Error("Timeout waiting for sync");
    }
  }

  return r;
}